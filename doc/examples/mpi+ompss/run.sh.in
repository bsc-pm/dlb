#!/bin/bash

# variables detected at configure time
MPIEXEC=@MPIEXEC@
MPIEXEC_EXPORT_FLAG=@MPIEXEC_EXPORT_FLAG@

# variables to be modified by the user
TRACE=0
DLB=0
MPIEXEC_BIND_FLAG=""

APP="./mpi_ompss_pils"
ARGS="/dev/null 0.1 50 500"

if [[ $TRACE == 1 ]] ; then
    PRELOAD="$EXTRAE_HOME/lib/libnanosmpitrace.so"
    export EXTRAE_CONFIG_FILE="extrae.xml"
    export NX_ARGS+=" --instrumentation=extrae"
    if [[ $DLB == 1 ]] ; then
        TRACENAME="pils_dlb.prv"
    else
        TRACENAME="pils.prv"
    fi
fi

if [[ $DLB == 1 ]] ; then
    export NX_ARGS+=" --enable-block --enable-dlb"
    export DLB_ARGS+=" --lewi"
else
    export DLB_ARGS+=" --no-lewi"
fi

$MPIEXEC -np 2 $MPIEXEC_BIND_FLAG $MPIEXEC_EXPORT_FLAG LD_PRELOAD=$PRELOAD $APP $ARGS

if [[ $TRACE == 1 ]] ; then
    $EXTRAE_HOME/bin/mpi2prv -f TRACE.mpits -no-keep-mpits -o "$TRACENAME"
    rm -f TRACE.spawn
fi
